pipelines:
  default:
    - step:
        name: Build a Docker image and PDF then upload the image
        image: atlassian/default-image:latest
        services:
          - docker
        script:
          - git submodule update --init
          - curl -L https://github.com/docker/compose/releases/download/1.21.2/docker-compose-`uname -s`-`uname -m` > docker-compose
          - chmod +x docker-compose
          - sudo mv docker-compose /usr/local/bin
          - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin
          - docker-compose pull
          - docker-compose build
          - docker-compose up --exit-code-from article_build
          - ./pipeline/deploy_image.sh
        artifacts:
          - main.pdf
    - step:
        name: Upload a PDF
        deployment: production
        image: python:3.5.1
        script:
          - ./pipeline/deploy_pdf.sh
        services:
          - docker
